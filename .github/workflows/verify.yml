name: RTL-to-GDSII Verification

on:
  push:
    branches: [ "main" ]
    tags: [ 'v*' ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

jobs:
  full-flow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- PERFORMANCE OPTIMIZATION ---
      # Cache the ~3GB Sky130 PDK to save CI time and bandwidth.
      # Volare will automatically skip downloading if the target hash exists in this cached directory.
      - name: Cache Sky130 PDK
        id: cache-pdk
        uses: actions/cache@v4
        with:
          path: pdks
          key: sky130-pdk-${{ runner.os }}-v1
          restore-keys: |
            sky130-pdk-${{ runner.os }}-

      - name: Pull c4o-core Image
        run: docker pull ghcr.io/anlit75/c4o-core:v1.1.1

      - name: 1. Lint Check
        run: make lint

      - name: 2. Simulation
        run: make sim

      - name: 3. Logic Synthesis
        run: make synth

      - name: 4. Physical Design (GDSII)
        # This step will automatically trigger 'make pdk' first
        run: make gds

      - name: Verify GDS Output
        run: |
          if [ ! -s build/blinky.gds ]; then
            echo "Error: GDS file missing or empty!"
            exit 1
          fi
          ls -lh build/blinky.gds

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blinky-gds
          path: |
            build/blinky.gds
            src/runs
